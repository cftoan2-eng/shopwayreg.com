import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
import { Play, Pause, ChevronLeft, ChevronRight, X, Phone, Image as ImageIcon, Facebook } from "lucide-react";

/**
 * SHOP ACC LI√äN QU√ÇN ‚Äì SINGLE FILE
 * ------------------------------------------------------
 * ‚úÖ Ch·ª©c nƒÉng ch√≠nh:
 *  - Danh s√°ch acc (·∫£nh + th√¥ng tin c∆° b·∫£n)
 *  - Xem ·∫£nh d·∫°ng slideshow (modal/lightbox)
 *  - T·ª± ƒë·ªông chuy·ªÉn slide (auto), Next/Prev
 *  - N√∫t Play/Pause, thanh ch·∫•m ch·ªâ b√°o, ƒë·∫øm slide
 *  - Ph√≠m t·∫Øt: ‚Üê/‚Üí (chuy·ªÉn), Space (Play/Pause), Esc (ƒê√≥ng), A (Prev), D (Next)
 *  - Pause khi r√™ chu·ªôt l√™n ·∫£nh, ti·∫øp t·ª•c khi r·ªùi chu·ªôt
 *  - H·ªó tr·ª£ vu·ªët tr√™n mobile (swipe)
 *  - T√¨m ki·∫øm & L·ªçc c∆° b·∫£n, S·∫Øp x·∫øp theo gi√°
 *  - Ch·ªâ mua qua Facebook ch√≠nh ch·ªß
 *
 * üõ†Ô∏è Tu·ª≥ ch·ªânh nhanh:
 *  1) ƒê·ªîI LINK FACEBOOK ·ªü const FACEBOOK_URL b√™n d∆∞·ªõi.
 *  2) S·ª≠a d·ªØ li·ªáu ACC trong m·∫£ng ACCS ƒë·ªÉ ƒëƒÉng s·∫£n ph·∫©m th·∫≠t.
 *  3) Thay ·∫£nh b·∫±ng link c·ªßa b·∫°n (Google Drive public, Imgur, v.v.).
 *
 * ‚ö° Ch·∫°y th·ª≠: D√°n file n√†y v√†o d·ª± √°n React (Vite/Create React App) l√† ch·∫°y.
 */

// üëâ THAY LINK N√ÄY B·∫∞NG FACEBOOK CH√çNH CH·ª¶ C·ª¶A B·∫†N
const FACEBOOK_URL = "https://www.facebook.com/toan.nguyen.955207";

// üëâ DATA DEMO ‚Äì H√£y thay b·∫±ng data th·∫≠t
const ACCS = [
  {
    id: "A001",
    title: "Acc Reg vanhen th·∫ßn th√°m  / 14 t∆∞·ªõng, 14 skin",
    price: 25000,
    rank: "ƒê·ªìng",
    server: "VN",
    images: [
      "https://drive.google.com/file/d/1tLs4hXlM57LQw5WPKSKq9yAJUbiZAl7I/view?usp=sharing",
      "https://drive.google.com/file/d/1NfVFngf4gDVmlmsDlg_a0A70j5dV78vb/view?usp=sharing",
      "https://drive.google.com/file/d/1Gc9UMhq702fpSyf5gpfXFLX4yXruPrnZ/view?usp=sharing",
    ],
    notes: "Kh√¥ng li√™n k·∫øt, tr·∫Øng th√¥ng tin, b·∫£o h√†nh 7 ng√†y",
  },
  {
    id: "A002",
    title: "Acc Kim C∆∞∆°ng ‚Äì 65 t∆∞·ªõng / 120 skin",
    price: 169000,
    rank: "Kim C∆∞∆°ng",
    server: "VN",
    images: [
      "https://images.unsplash.com/photo-1511512578047-dfb367046420?w=1200",
      "https://picsum.photos/seed/a002a/1200/800",
      "https://picsum.photos/seed/a002b/1200/800",
    ],
    notes: "Tr·∫Øng th√¥ng tin, login Garena",
  },
  {
    id: "A003",
    title: "Acc Tinh Anh ‚Äì 40 t∆∞·ªõng / 60 skin",
    price: 89000,
    rank: "Tinh Anh",
    server: "VN",
    images: [
      "https://images.unsplash.com/photo-1542751110-97427bbecf20?w=1200",
      "https://picsum.photos/seed/a003a/1200/800",
    ],
    notes: "ƒê·ªïi mail ƒë∆∞·ª£c, h·ªó tr·ª£ qua teamview",
  },
  {
    id: "A004",
    title: "Acc V√†ng ‚Äì 25 t∆∞·ªõng / 30 skin",
    price: 59000,
    rank: "V√†ng",
    server: "VN",
    images: [
      "https://picsum.photos/seed/a004a/1200/800",
      "https://picsum.photos/seed/a004b/1200/800",
    ],
    notes: "Ph√π h·ª£p t√¢n th·ªß, r·∫ª ƒë·∫πp",
  },
];

// Helper: ƒë·ªãnh d·∫°ng ti·ªÅn VND
const vnd = (n) => new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(n);

// Swipe detection (simple)
function useSwipe(ref, onSwipeLeft, onSwipeRight) {
  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    let startX = 0;
    let startY = 0;

    const onTouchStart = (e) => {
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
    };
    const onTouchEnd = (e) => {
      const t = e.changedTouches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 30) {
        if (dx < 0) onSwipeLeft?.(); else onSwipeRight?.();
      }
    };

    el.addEventListener("touchstart", onTouchStart, { passive: true });
    el.addEventListener("touchend", onTouchEnd, { passive: true });
    return () => {
      el.removeEventListener("touchstart", onTouchStart);
      el.removeEventListener("touchend", onTouchEnd);
    };
  }, [ref, onSwipeLeft, onSwipeRight]);
}

export default function ShopLienQuan() {
  const [query, setQuery] = useState("");
  const [rank, setRank] = useState("all");
  const [sort, setSort] = useState("new");

  const [lightbox, setLightbox] = useState(null); // { acc, index, playing }
  const [auto, setAuto] = useState(true);
  const intervalMs = 3000; // t·ªëc ƒë·ªô slideshow

  const filtered = useMemo(() => {
    let arr = ACCS.filter((a) =>
      a.title.toLowerCase().includes(query.toLowerCase()) || a.id.toLowerCase().includes(query.toLowerCase())
    );
    if (rank !== "all") arr = arr.filter((a) => a.rank === rank);
    if (sort === "price-asc") arr = [...arr].sort((a, b) => a.price - b.price);
    if (sort === "price-desc") arr = [...arr].sort((a, b) => b.price - a.price);
    if (sort === "new") arr = [...arr].sort((a, b) => (a.id < b.id ? 1 : -1));
    return arr;
  }, [query, rank, sort]);

  const openLightbox = (acc, startIndex = 0) => {
    setLightbox({ acc, index: startIndex, playing: true });
  };
  const closeLightbox = () => setLightbox(null);

  // Keyboard shortcuts
  useEffect(() => {
    const onKey = (e) => {
      if (!lightbox) return;
      if (e.key === "Escape") closeLightbox();
      if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") nextSlide();
      if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") prevSlide();
      if (e.code === "Space") {
        e.preventDefault();
        togglePlay();
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [lightbox]);

  const nextSlide = useCallback(() => {
    setLightbox((lb) => {
      if (!lb) return lb;
      const next = (lb.index + 1) % lb.acc.images.length;
      return { ...lb, index: next };
    });
  }, []);

  const prevSlide = useCallback(() => {
    setLightbox((lb) => {
      if (!lb) return lb;
      const total = lb.acc.images.length;
      const prev = (lb.index - 1 + total) % total;
      return { ...lb, index: prev };
    });
  }, []);

  const togglePlay = useCallback(() => {
    setLightbox((lb) => (lb ? { ...lb, playing: !lb.playing } : lb));
  }, []);

  // Auto-play
  useEffect(() => {
    if (!lightbox || !lightbox.playing || !auto) return;
    const id = setInterval(() => nextSlide(), intervalMs);
    return () => clearInterval(id);
  }, [lightbox, nextSlide, auto]);

  return (
<div className="min-h-screen bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 text-slate-100">
    <header className="sticky top-0 z-20 backdrop-blur supports-[backdrop-filter]:bg-slate-900/60 bg-slate-900/80 border-b border-white/10">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
            <div className="flex items-center gap-2">
                <ImageIcon className="w-7 h-7" />
                <h1 className="text-xl sm:text-2xl font-bold tracking-tight">Shop Acc Li√™n Qu√¢n</h1>
            </div>
            <div className="ml-auto flex flex-wrap items-center gap-2">
                <input value={query}
                       onChange={(e) => setQuery(e.target.value)}
                placeholder="T√¨m m√£ acc ho·∫∑c m√¥ t·∫£..."
                className="px-3 py-2 rounded-2xl bg-slate-800/70 border border-white/10 focus:outline-none focus:ring focus:ring-sky-500/40 w-48 sm:w-64"
                />
                <select value={rank} onChange={(e) =>
                    setRank(e.target.value)} className="px-3 py-2 rounded-2xl bg-slate-800/70 border border-white/10">
                    <option value="all">T·∫•t c·∫£ rank</option>
                    <option value="Cao Th·ªß">Cao Th·ªß</option>
                    <option value="Kim C∆∞∆°ng">Kim C∆∞∆°ng</option>
                    <option value="Tinh Anh">Tinh Anh</option>
                    <option value="V√†ng">V√†ng</option>
                </select>
                <select value={sort} onChange={(e) =>
                    setSort(e.target.value)} className="px-3 py-2 rounded-2xl bg-slate-800/70 border border-white/10">
                    <option value="new">M·ªõi nh·∫•t</option>
                    <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
                    <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
                </select>
                <a href={FACEBOOK_URL} target="_blank" rel="noreferrer" className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-sky-500 hover:bg-sky-600 transition shadow">
                    <Facebook className="w-4 h-4" /> Facebook ch√≠nh ch·ªß
                </a>
            </div>
        </div>
    </header>

    <main className="max-w-6xl mx-auto px-4 py-6">
        <div className="mb-4 flex items-center justify-between">
            <p className="text-sm text-slate-300/80">Ch·ªâ b√°n b·∫±ng c√°ch xem ·∫£nh r·ªìi li√™n h·ªá Facebook. Kh√¥ng h·ªó tr·ª£ mua t·ª± ƒë·ªông.</p>
            <label className="flex items-center gap-2 text-sm select-none cursor-pointer">
                <input type="checkbox" checked={auto} onChange={(e) => setAuto(e.target.checked)} />
                <span>T·ª± ƒë·ªông chuy·ªÉn slide</span>
            </label>
        </div>

        {filtered.length === 0 ? (
        <div className="text-center py-24 opacity-80">Kh√¥ng t√¨m th·∫•y acc ph√π h·ª£p. H√£y th·ª≠ t·ª´ kho√° kh√°c.</div>
        ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
            {filtered.map((acc) => (
            <AccCard key={acc.id} acc={acc} onPreview={() =>
                openLightbox(acc, 0)} />
                ))}
        </div>
        )}
    </main>

    {lightbox && (
    <Lightbox data={lightbox}
              onClose={closeLightbox}
              onNext={nextSlide}
              onPrev={prevSlide}
              onTogglePlay={togglePlay}
              autoEnabled={auto} />
    )}

    <footer className="max-w-6xl mx-auto px-4 py-8 text-slate-400 text-xs">
        <div className="flex flex-wrap items-center gap-3 justify-between">
            <p>¬© {new Date().getFullYear()} Shop Acc Li√™n Qu√¢n. M·ªçi quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
            <p>Ph√≠m t·∫Øt: ‚Üê/‚Üí, A/D (chuy·ªÉn), Space (Play/Pause), Esc (ƒê√≥ng)</p>
        </div>
    </footer>
</div>
  );
}

function AccCard({ acc, onPreview }) {
  return (
<div className="rounded-2xl overflow-hidden bg-slate-900/60 border border-white/10 shadow-lg hover:shadow-sky-900/20 transition">
    <div className="aspect-video bg-slate-800 overflow-hidden">
        <img src={acc.images[0]}
             alt={acc.title}
             className="w-full h-full object-cover hover:scale-105 transition duration-500"
             loading="lazy" />
    </div>
    <div className="p-4 flex flex-col gap-3">
        <div className="flex items-start justify-between gap-3">
            <div>
                <h3 className="font-semibold leading-tight">{acc.title}</h3>
                <div className="text-xs text-slate-400 mt-1">M√£: {acc.id} ‚Ä¢ Rank: {acc.rank} ‚Ä¢ Server: {acc.server}</div>
            </div>
            <div className="text-lg font-bold text-sky-300 whitespace-nowrap">{vnd(acc.price)}</div>
        </div>
        <p className="text-sm text-slate-300/90 line-clamp-2">{acc.notes}</p>
        <div className="flex items-center gap-2 mt-1">
            <button onClick={onPreview} className="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-white/10 text-sm inline-flex items-center gap-2">
                <ImageIcon className="w-4 h-4" /> Xem ·∫£nh
            </button>
            <a href={FACEBOOK_URL} target="_blank" rel="noreferrer" className="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm inline-flex items-center gap-2 shadow">
                <Phone className="w-4 h-4" /> Li√™n h·ªá Facebook
            </a>
        </div>
    </div>
</div>
  );
}

function Lightbox({ data, onClose, onNext, onPrev, onTogglePlay, autoEnabled }) {
  const { acc, index, playing } = data;
  const imgRef = useRef(null);
  useSwipe(imgRef, onNext, onPrev);

  const [hovering, setHovering] = useState(false);
  const showPlay = autoEnabled;

  return (
<div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex flex-col">
    <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-white/10">
        <div className="flex items-center gap-3">
            <span className="px-2 py-1 text-[10px] rounded bg-white/10 border border-white/10">{acc.id}</span>
            <h2 className="text-sm sm:text-base font-semibold line-clamp-1">{acc.title}</h2>
        </div>
        <div className="flex items-center gap-2">
            <a href={FACEBOOK_URL} target="_blank" rel="noreferrer" className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm">
                <Facebook className="w-4 h-4" /> Facebook ch√≠nh ch·ªß
            </a>
            <button onClick={onClose} className="p-2 rounded-xl hover:bg-white/10">
                <X className="w-5 h-5" />
            </button>
        </div>
    </div>

    <div className="relative flex-1 flex flex-col items-center justify-center select-none">
        <div className="absolute inset-x-0 top-2 text-center text-xs text-white/70">{index + 1} / {acc.images.length}</div>

        <div ref={imgRef}
             className="max-w-[92vw] max-h-[72vh] md:max-h-[78vh] overflow-hidden rounded-2xl border border-white/10 bg-slate-900"
             onMouseEnter={() =>
            setHovering(true)}
            onMouseLeave={() => setHovering(false)}
            >
            <img src={acc.images[index]}
                 alt={`${acc.title} ‚Äì ·∫£nh ${index + 1}`}
                 className="block w-full h-full object-contain"
                 draggable={false} />
        </div>

        {/* Controls */}
        <div className="mt-4 flex items-center gap-3">
            <button onClick={onPrev} className="p-3 rounded-2xl bg-white/10 hover:bg-white/20 border border-white/10 inline-flex">
                <ChevronLeft className="w-5 h-5" />
            </button>
            {showPlay && (
            <button onClick={onTogglePlay} className="px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 border border-white/10 inline-flex items-center gap-2 text-sm">
                {playing ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                {playing ? "Pause" : "Play"}
            </button>
            )}
            <button onClick={onNext} className="p-3 rounded-2xl bg-white/10 hover:bg-white/20 border border-white/10 inline-flex">
                <ChevronRight className="w-5 h-5" />
            </button>
        </div>

        {/* Dots */}
        <div className="mt-3 flex flex-wrap items-center justify-center gap-2">
            {acc.images.map((_, i) => (
            <Dot key={i} active={i === index} onClick={() =>
                (i === index ? null : window.dispatchEvent(new KeyboardEvent('keydown', { key: i > index ? 'ArrowRight' : 'ArrowLeft' })))} />
                ))}
        </div>

        {/* Hint */}
        <div className="mt-3 text-[11px] text-white/60 text-center px-4">
            G·ª£i √Ω: d√πng ph√≠m ‚Üê/‚Üí ho·∫∑c A/D ƒë·ªÉ chuy·ªÉn; Space ƒë·ªÉ Play/Pause; Esc ƒë·ªÉ ƒë√≥ng. Vu·ªët tr√°i/ph·∫£i tr√™n ƒëi·ªán tho·∫°i.
        </div>
    </div>
</div>
  );
}

function Dot({ active, onClick }) {
  return (
<button onClick={onClick}
        className={`w-2.5 h-2.5 rounded-full border ${active ? "bg-sky-400 border-sky-300" : "bg-white/20 border-white/30" }`}
        aria-label={active ? "Slide hi·ªán t·∫°i" : "Chuy·ªÉn t·ªõi slide" } />
  );
}
